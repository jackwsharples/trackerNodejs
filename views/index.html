<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tracker â€¢ Vehicles & Rides</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.468.0/font/lucide.css">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Dark (default) */
      --bg:#0b0f14; --bg-2:#070a0f;
      --panel:#111823; --panel-2:#0f1620;
      --text:#e8eef7; --muted:#9fb0c6;
      --brand:#6ea8fe; --brand-2:#91c2ff; --accent:#22d3ee;
      --danger:#ff6b6b; --ok:#4ade80;
      --border:rgba(255,255,255,.08);
      --shadow:rgba(0,0,0,.35);
    }
    /* Light theme overrides */
    .theme-light{
      --bg:#f7fbff; --bg-2:#eef5ff;
      --panel:#ffffff; --panel-2:#f6f9ff;
      --text:#0c1a2b; --muted:#4f647f;
      --brand:#0b6bff; --brand-2:#1a7bff; --accent:#06b6d4;
      --danger:#e11d48; --ok:#16a34a;
      --border:rgba(2,22,38,.12);
      --shadow:rgba(0,0,0,.08);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,Segoe UI,Arial,sans-serif; background:linear-gradient(180deg,var(--bg),var(--bg-2) 60%); color:var(--text)}
    a{color:var(--brand)}

    .wrap{max-width:1200px; margin:0 auto; padding:16px}
    header{position:sticky; top:0; z-index:20; backdrop-filter:saturate(120%) blur(6px); background:color-mix(in oklab, var(--bg) 80%, transparent); border-bottom:1px solid var(--border)}
    .nav{display:flex; align-items:center; gap:12px; padding:12px 16px}
    .logo{display:flex; align-items:center; gap:10px; font-weight:700}
    .logo .dot{width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 12px var(--accent)}
    .tabs{display:flex; gap:6px; margin-left:18px}
    .tab{padding:8px 12px; border-radius:10px; color:var(--muted); cursor:pointer; border:1px solid var(--border)}
    .tab.active{color:var(--text); background:linear-gradient(180deg,var(--panel),var(--panel-2)); box-shadow:0 8px 24px var(--shadow)}
    .spacer{flex:1}

    .chip{display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:999px; border:1px solid var(--border); background:linear-gradient(180deg,var(--panel),var(--panel-2)); color:var(--muted)}
    .chip button{all:unset; cursor:pointer; padding:.25rem .5rem; border-radius:8px; border:1px solid var(--border)}

    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 12px; background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid var(--border); color:var(--text); border-radius:12px; cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn.danger{border-color:#5c1b1b; background:linear-gradient(180deg,#2a0e0e,#1c0b0b); color:#ffb3b3}
    .btn.primary{background:linear-gradient(180deg,#122843,#0e1b30); border-color:#1e3a5f}

    .main{padding:18px;}
    .grid{display:grid; grid-template-columns:1fr; gap:16px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 12px 34px var(--shadow)}
    .card h2{margin:0 0 10px 0; font-size:18px}
    .card h3{margin:10px 0 8px 0; font-size:16px; color:var(--brand-2)}
    .muted{color:var(--muted)}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .stack{display:flex; flex-direction:column; gap:10px}
    .pill{padding:6px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted)}
    .flex{display:flex; gap:16px; align-items:center; flex-wrap:wrap}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    @media (max-width: 980px){ .two{grid-template-columns:1fr;}}

    /* Map blocks */
    .map{width:100%; height:420px; border-radius:14px; border:1px solid var(--border);}
    .map.sm{height:300px}

    footer{margin-top:28px; padding:20px; text-align:center; color:var(--muted)}

    /* Vehicle gallery */
    .vehicles{display:grid; grid-template-columns:repeat( auto-fill, minmax(240px, 1fr) ); gap:16px}
    .vehicle-card{border:1px solid var(--border); background:linear-gradient(180deg,var(--panel),var(--panel-2)); border-radius:16px; overflow:hidden; cursor:pointer; box-shadow:0 10px 28px var(--shadow); transition:transform .12s ease}
    .vehicle-card:hover{transform:translateY(-2px)}
    .vehicle-card img{width:100%; aspect-ratio: 16/9; object-fit:cover; display:block; background:linear-gradient(45deg, #1e293b, #0f172a)}
    .vehicle-card .vc-body{padding:12px 14px; display:flex; align-items:center; justify-content:space-between}
    .vehicle-card .vc-name{font-weight:600}
    .vehicle-card .vc-type{color:var(--muted); font-size:12px}

    /* Light/dark toggle */
    .toggle{display:inline-flex; align-items:center; gap:10px; padding:8px 12px; border-radius:12px; border:1px solid var(--border); background:linear-gradient(180deg,var(--panel),var(--panel-2)); color:var(--muted); cursor:pointer}
  </style>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000000">

  <!-- iOS specific -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" >

</head>
<body>
  <header>
    <div class="nav wrap">
      <div class="logo"><span class="dot"></span> Tracker</div>
      <div class="tabs">
        <div class="tab active" data-route="home">Home</div>
        <div class="tab" data-route="vehicles">Vehicles</div>
        <div class="tab" data-route="testing">Testing</div>
      </div>
      <div class="spacer"></div>

      <button id="themeBtn" class="toggle" title="Toggle light/dark">
        <i class="lucide lucide-sun"></i>
        <span id="themeLabel">Dark</span>
      </button>

      <div class="chip" style="margin-left:10px">
        <span id="envLabel">ENV: same-origin</span>
        <button id="toggleEnv">switch</button>
      </div>
    </div>
  </header>

  <main class="main wrap">
    <!-- HOME -->
    <section id="page-home" class="grid">
      <div class="card">
        <h2>Hi, I'm <span id="homeName">Jack Sharples</span></h2>
        <p id="homeDesc" class="muted">
          
          Computer Science major with a minor in Cyber Secrity at App State. Big into bikes, been racing mountain bikes since a kid and recently got into motorbikes aswell.
          This tracker started as a summer project while in school to replace the airtags on my motorbike.
        </p>
      </div>

      <div class="card">
        <div class="flex">
          <h3 style="margin:0">Live Tracker Demo</h3>
          <div class="spacer"></div>
          <button class="btn" id="demoRestart">Restart</button>
        </div>
        <div id="demoMap" class="map" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- VEHICLES (list view + details view) -->
    <section id="page-vehicles" class="grid" style="display:none">
      <div id="vehiclesList" class="grid">
        <div class="flex">
          <h2 style="margin:0">Your Vehicles</h2>
          <div class="spacer"></div>
          <button class="btn" id="btnAddVehicle"><i class="lucide lucide-plus"></i> Add Vehicle</button>
        </div>
        <div class="vehicles" id="vehiclesGrid"></div>
      </div>

      <div id="vehicleDetails" class="grid" style="display:none">
        <div class="flex">
          <button class="btn" id="btnBackVehicles"><i class="lucide lucide-arrow-left"></i> Back</button>
          <div class="spacer"></div>
          <button class="btn danger" id="btnDeleteVehicle"><i class="lucide lucide-trash-2"></i> Delete</button>
        </div>

        <div class="two">
          <div class="card">
            <div class="flex">
              <div>
                <h2 id="vdName" style="margin:0">Vehicle</h2>
                <span id="vdType" class="pill">Type</span>
              </div>
              <div class="spacer"></div>
              <div class="stack" style="min-width:220px">
                <label class="muted">Upload/Change Photo</label>
                <input id="photoInput" type="file" accept="image/*" class="btn" />
                <button class="btn" id="savePhotoBtn">Save Photo</button>
              </div>
            </div>
            <div style="margin-top:10px">
              <img id="vdImg" alt="vehicle photo" style="width:100%; max-height:240px; object-fit:cover; border-radius:12px; border:1px solid var(--border)"/>
            </div>
          </div>

          <div class="card">
            <h3 style="margin:0 0 8px 0">Live Ping</h3>
            <div id="liveMap" class="map sm"></div>
          </div>
        </div>

        <div class="card">
          <div class="flex">
            <h3 style="margin:0">Tracker (Most recent ride)</h3>
            <div class="spacer"></div>
            <label class="muted" for="rideSelect">Past rides:</label>
            <select id="rideSelect" class="btn"></select>
            <button class="btn" id="refreshRideBtn"><i class="lucide lucide-rotate-cw"></i> Refresh</button>
          </div>
          <div id="trackMap" class="map" style="margin-top:10px"></div>
        </div>
      </div>
    </section>

    <!-- TESTING -->
    <section id="page-testing" class="grid" style="display:none">
      <!---->
      <div class="card">
        <h3>Idea Board</h3>
        <div class="stack">
          <label class="muted">Add an idea</label>
          <input id="ideaInput" class="btn" placeholder="e.g., Split rides automatically when stopped for > 10 min"/>
          <div class="row">
            <button class="btn" id="addIdea">Add</button>
            <button class="btn" id="clearIdeas">Clear Board</button>
          </div>
          <ul id="ideaList" class="stack" style="list-style:none; padding:0; margin-top:4px"></ul>
        </div>
      </div>

      <div class="card">
        <h3>Raw JSON Pings</h3>
        <pre id="rawJson" class="btn" style="white-space:pre-wrap; overflow:auto; max-height:420px">Loadingâ€¦</pre>
      </div>

      <div class="card">
        <h2>Testing / Production</h2>
        <div class="stack">
          <div class="row">
            <div class="stack" style="min-width:280px; flex:1">
              <label class="muted">API Base URL (optional). Empty = same origin</label>
              <input id="apiBase" class="btn" placeholder="https://your-http-service.up.railway.app" />
            </div>
          </div>
          <div class="row">
            <button class="btn" id="saveApi">Save</button>
            <button class="btn" id="clearApi">Clear</button>
            <button class="btn danger" id="btnReset">Delete all stored data</button>
          </div>
          <p class="muted">The UI will call <code>GET /pings</code>, <code>DELETE /pings</code>, and <code>GET /latest</code> (fallbacks to last of /pings). If your reset endpoint is different, tweak <em>resetData()</em>.</p>
        </div>
      </div>
      
    </section>
  </main>

  <footer>
    <small>Â© <span id="year"></span> Tracker â€¢ Vehicles & Rides</small>
  </footer>

  <script>
    // ------------------- THEME -------------------
    const themeBtn = document.getElementById('themeBtn');
    const themeLabel = document.getElementById('themeLabel');
    function getTheme(){ return localStorage.getItem('theme') || 'dark'; }
    function applyTheme(t){
      document.body.classList.toggle('theme-light', t==='light');
      themeLabel.textContent = t==='light' ? 'Light' : 'Dark';
      const icon = themeBtn.querySelector('i');
      icon.className = t==='light' ? 'lucide lucide-moon' : 'lucide lucide-sun';
    }
    function setTheme(t){ localStorage.setItem('theme', t); applyTheme(t); }
    themeBtn.onclick = ()=> setTheme(getTheme()==='dark' ? 'light' : 'dark');
    applyTheme(getTheme());

    // ------------------- ROUTER -------------------
    const pages = {
      home: document.getElementById('page-home'),
      vehicles: document.getElementById('page-vehicles'),
      testing: document.getElementById('page-testing')
    };
    const tabs = Array.from(document.querySelectorAll('.tab'));
    function setRoute(name){
      tabs.forEach(t=>t.classList.toggle('active', t.dataset.route===name));
      Object.entries(pages).forEach(([k,el])=> el.style.display = (k===name)?'grid':'none');
      if(name==='vehicles'){ renderVehicles(); }
      if(name==='testing'){ refreshRaw(); }
      if(name==='home'){ initDemoMap(); }
    }
    tabs.forEach(t=> t.addEventListener('click', ()=> setRoute(t.dataset.route)));

    // ------------------- ENV / API BASE -------------------
    const apiBaseInput = document.getElementById('apiBase');
    const envLabel = document.getElementById('envLabel');
    const toggleEnvBtn = document.getElementById('toggleEnv');
    function getBase(){ return localStorage.getItem('apiBase') || ''; }
    function setBase(v){ if(v) localStorage.setItem('apiBase', v); else localStorage.removeItem('apiBase'); updateEnvLabel(); }
    function updateEnvLabel(){ envLabel.textContent = 'ENV: ' + (getBase()||'same-origin'); apiBaseInput.value = getBase(); }
    document.getElementById('saveApi').onclick = ()=> setBase(apiBaseInput.value.trim());
    document.getElementById('clearApi').onclick = ()=> setBase('');
    toggleEnvBtn.onclick = ()=> { if(getBase()){ setBase(''); } else { apiBaseInput.focus(); } };
    updateEnvLabel();

    // ------------------- FETCH HELPERS -------------------
    async function api(path, opts){
      const base = getBase();
      const url = base ? base.replace(/\/$/,'') + path : path;
      const res = await fetch(url, opts);
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res;
    }
    async function getPings(){
      try{
        const res = await api('/pings');
        const data = await res.json();
        const list = Array.isArray(data) ? data : (Array.isArray(data?.pings) ? data.pings : []);
        return list;
      }catch(e){ console.error('getPings failed', e); return []; }
    }
    async function getLatest(){
      try{
        const res = await api('/latest');
        return await res.json();
      }catch(e){
        const list = await getPings();
        return list.sort((a,b)=> new Date(a.timestamp)-new Date(b.timestamp)).slice(-1)[0] || null;
      }
    }
    async function resetData(){
      try{ await api('/pings', { method:'DELETE' }); }
      catch(e){ try{ await api('/reset', { method:'POST' }); } catch(e2){ alert('Reset failed. Ensure DELETE /pings or POST /reset exists.'); return; } }
      alert('All stored data cleared');
      refreshRaw(); drawTrackMap(); drawLiveMap();
    }
    document.getElementById('btnReset').onclick = resetData;

    async function refreshRaw(){
      const list = await getPings();
      const doc = { count:list.length, pings:list };
      document.getElementById('rawJson').textContent = JSON.stringify(doc, null, 2);
    }

    // ------------------- IDEAS BOARD (local) -------------------
    const ideaList = document.getElementById('ideaList');
    function loadIdeas(){ (JSON.parse(localStorage.getItem('ideas')||'[]')).forEach(addIdeaLi); }
    function saveIdeas(){ const items = Array.from(document.querySelectorAll('#ideaList li')).map(li=>li.textContent); localStorage.setItem('ideas', JSON.stringify(items)); }
    function addIdeaLi(text){ const li = document.createElement('li'); li.textContent = text; li.className='btn'; ideaList.appendChild(li); }
    document.getElementById('addIdea').onclick = ()=>{ const v = document.getElementById('ideaInput').value.trim(); if(!v) return; addIdeaLi(v); saveIdeas(); document.getElementById('ideaInput').value=''; };
    document.getElementById('clearIdeas').onclick = ()=>{ ideaList.innerHTML=''; saveIdeas(); };
    loadIdeas();

    // ------------------- HOME: LIVE DEMO -------------------
    let demoMap, demoMarker, demoLine, demoTimer;
    const demoPoints = [
      {lat:36.216367, lon:-81.674616},
      {lat:36.215520, lon:-81.674590},
      {lat:36.213739, lon:-81.675477},
      {lat:36.212571, lon:-81.675796},
      {lat:36.211750, lon:-81.675553},
      {lat:36.211486, lon:-81.676403}
    ];
    function initDemoMap(){
      if(demoMap) return;
      demoMap = L.map('demoMap');
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {subdomains:'abcd',maxZoom:20}).addTo(demoMap);
      demoMap.setView([demoPoints[0].lat, demoPoints[0].lon], 15);
      demoMarker = L.marker([demoPoints[0].lat, demoPoints[0].lon]).addTo(demoMap);
      demoLine = L.polyline([[demoPoints[0].lat, demoPoints[0].lon]]).addTo(demoMap);
      startDemoLoop();
    }
    function startDemoLoop(){
      let i=0;
      if(demoTimer) clearInterval(demoTimer);
      demoTimer = setInterval(()=>{
        i = (i+1) % demoPoints.length;
        const p = demoPoints[i];
        demoMarker.setLatLng([p.lat, p.lon]);
        const coords = demoLine.getLatLngs(); coords.push([p.lat,p.lon]); demoLine.setLatLngs(coords);
        demoMap.panTo([p.lat,p.lon]);
        if(i===demoPoints.length-1){
          setTimeout(()=>{ demoLine.setLatLngs([[demoPoints[0].lat, demoPoints[0].lon]]); demoMarker.setLatLng([demoPoints[0].lat, demoPoints[0].lon]); demoMap.setView([demoPoints[0].lat,demoPoints[0].lon],15); }, 800);
        }
      }, 1200);
    }
    document.getElementById('demoRestart').onclick = ()=>{
      if(demoTimer) clearInterval(demoTimer);
      if(demoLine) demoLine.setLatLngs([[demoPoints[0].lat, demoPoints[0].lon]]);
      if(demoMarker) demoMarker.setLatLng([demoPoints[0].lat, demoPoints[0].lon]);
      demoMap.setView([demoPoints[0].lat,demoPoints[0].lon],15);
      startDemoLoop();
    };

    // ------------------- VEHICLES -------------------
    const vehiclesGrid = document.getElementById('vehiclesGrid');
    const vehiclesListView = document.getElementById('vehiclesList');
    const vehicleDetailsView = document.getElementById('vehicleDetails');
    const btnBackVehicles = document.getElementById('btnBackVehicles');
    const btnAddVehicle = document.getElementById('btnAddVehicle');
    const btnDeleteVehicle = document.getElementById('btnDeleteVehicle');

    function seedVehicles(){
      if(localStorage.getItem('vehicles')) return;
      const defaults = [
        { id: 'veh-crf300l', name: 'CRF300L', type: 'Motorbike', img: '/public/images/Crf300.png' },
        { id: 'veh-car', name: 'My Car', type: 'Car', img: '/public/images/crossTrek.png' }
      ];
      localStorage.setItem('vehicles', JSON.stringify(defaults));
    }
    function getVehicles(){ return JSON.parse(localStorage.getItem('vehicles') || '[]'); }
    function setVehicles(v){ localStorage.setItem('vehicles', JSON.stringify(v)); }

    let currentVehicle = null;

    function renderVehicles(){
      seedVehicles();
      vehiclesGrid.innerHTML = '';
      const list = getVehicles();
      list.forEach(v=> vehiclesGrid.appendChild(vehicleCard(v)));
      vehiclesListView.style.display = 'grid';
      vehicleDetailsView.style.display = 'none';
    }

    function vehicleCard(v){
      const card = document.createElement('div');
      card.className = 'vehicle-card';
      const img = document.createElement('img');
      img.src = v.img || '/public/images/moto.png';
      img.alt = v.name;
      const body = document.createElement('div');
      body.className = 'vc-body';
      const left = document.createElement('div');
      const name = document.createElement('div');
      name.className = 'vc-name';
      name.textContent = v.name;
      const type = document.createElement('div');
      type.className = 'vc-type';
      type.textContent = v.type || '';
      left.appendChild(name); left.appendChild(type);
      const arrow = document.createElement('i');
      arrow.className = 'lucide lucide-chevron-right';
      body.appendChild(left); body.appendChild(arrow);
      card.appendChild(img); card.appendChild(body);
      card.onclick = ()=> openVehicle(v.id);
      return card;
    }

    btnAddVehicle.onclick = ()=>{
      const baseId = 'veh-' + Math.random().toString(36).slice(2,8);
      const name = prompt('Vehicle name?', 'New Vehicle');
      if(!name) return;
      const type = prompt('Type (Motorbike/Car/etc.)', 'Motorbike') || 'Motorbike';
      const img = type.toLowerCase().includes('car') ? '/public/images/car.png' : '/public/images/moto.png';
      const list = getVehicles();
      list.push({ id: baseId, name, type, img });
      setVehicles(list);
      renderVehicles();
    };

    btnBackVehicles.onclick = ()=>{
      currentVehicle = null;
      renderVehicles();
    };

    btnDeleteVehicle.onclick = ()=>{
      if(!currentVehicle) return;
      const ok = confirm('Delete this vehicle?');
      if(!ok) return;
      const list = getVehicles().filter(v=> v.id !== currentVehicle.id);
      setVehicles(list);
      currentVehicle = null;
      renderVehicles();
    };

    const vdName = document.getElementById('vdName');
    const vdType = document.getElementById('vdType');
    const vdImg  = document.getElementById('vdImg');
    const photoInput = document.getElementById('photoInput');
    const savePhotoBtn = document.getElementById('savePhotoBtn');
    const rideSelect = document.getElementById('rideSelect');
    const refreshRideBtn = document.getElementById('refreshRideBtn');

    let liveMap, liveMarker;
    let trackMap, trackLine, trackMarkers = [];

    async function openVehicle(id){
      const v = getVehicles().find(x=> x.id===id);
      if(!v) return;
      currentVehicle = v;
      vdName.textContent = v.name;
      vdType.textContent = v.type || '';
      vdImg.src = v.img || '/public/images/moto.png';

      vehiclesListView.style.display = 'none';
      vehicleDetailsView.style.display = 'grid';

      setTimeout(()=>{
        initLiveMap();
        initTrackMap();
        drawLiveMap();
        drawTrackMap(true);
      }, 0);
    }

    // Photo upload -> save as base64 to localStorage
    savePhotoBtn.onclick = async ()=>{
      const file = photoInput.files?.[0];
      if(!file || !currentVehicle) return alert('Pick a file first');
      const reader = new FileReader();
      reader.onload = ()=>{
        const list = getVehicles();
        const idx = list.findIndex(v=> v.id===currentVehicle.id);
        if(idx>=0){
          list[idx].img = reader.result; // base64
          setVehicles(list);
          currentVehicle = list[idx];
          vdImg.src = currentVehicle.img;
          renderVehicles(); // update list thumbs
          alert('Saved photo!');
        }
      };
      reader.readAsDataURL(file);
    };

    // Live map
    function initLiveMap(){
      if(liveMap){ liveMap.remove(); liveMap=null; }
      liveMap = L.map('liveMap');
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {subdomains:'abcd',maxZoom:20}).addTo(liveMap);
      liveMap.setView([36.214,-81.668], 14);
    }
    async function drawLiveMap(){
      const last = await getLatest();
      if(!last || !Number.isFinite(last.lat) || !Number.isFinite(last.lon)) return;
      if(liveMarker) liveMap.removeLayer(liveMarker);
      liveMarker = L.circleMarker([last.lat,last.lon], { radius:8 }).addTo(liveMap).bindPopup(`Live ping<br>${new Date(last.timestamp).toLocaleString()}`);
      liveMap.setView([last.lat,last.lon], 16);
    }

    // Track map (rides)
    function initTrackMap(){
      if(trackMap){ trackMap.remove(); trackMap=null; }
      trackMap = L.map('trackMap');
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {subdomains:'abcd',maxZoom:20}).addTo(trackMap);
      trackMap.setView([36.214,-81.668], 14);
      rideSelect.onchange = ()=> drawTrackMap(false);
      refreshRideBtn.onclick = ()=> drawTrackMap(true);
    }
    function segmentByTime(points, gapSeconds=600){
      const out=[]; let cur=[]; let prev=null;
      for(const p of points){
        if(!Number.isFinite(p.lat) || !Number.isFinite(p.lon)) continue;
        const t = new Date(p.timestamp).getTime();
        if(prev && (t - prev) > gapSeconds*1000){ if(cur.length) out.push(cur); cur=[]; }
        cur.push(p); prev = t;
      }
      if(cur.length) out.push(cur);
      return out;
    }
    function clearTrackOverlays(){
      if(trackLine){ trackMap.removeLayer(trackLine); trackLine=null; }
      trackMarkers.forEach(m=> trackMap.removeLayer(m));
      trackMarkers=[];
    }
    async function drawTrackMap(rebuildDropdown){
      const list = await getPings();
      const pts = list.filter(p=> Number.isFinite(p.lat) && Number.isFinite(p.lon)).sort((a,b)=> new Date(a.timestamp)-new Date(b.timestamp));
      const groups = segmentByTime(pts, 600);
      if(rebuildDropdown){
        rideSelect.innerHTML='';
        groups.forEach((g, idx)=>{
          const s=g[0], e=g[g.length-1];
          const opt = document.createElement('option');
          opt.value = String(idx);
          opt.textContent = `${new Date(s.timestamp).toLocaleString()} â†’ ${new Date(e.timestamp).toLocaleString()} (${g.length} pts)`;
          rideSelect.appendChild(opt);
        });
        if(groups.length) rideSelect.value = String(groups.length-1); // most recent
      }
      clearTrackOverlays();
      if(!groups.length) return;
      const sel = parseInt(rideSelect.value || (groups.length-1), 10);
      const ride = groups[Math.max(0, Math.min(sel, groups.length-1))];
      const coords = ride.map(p=>[p.lat,p.lon]);
      trackLine = L.polyline(coords).addTo(trackMap);
      // start + end only
      if(ride.length){
        const s = ride[0], e = ride[ride.length-1];
        const sMk = L.marker([s.lat,s.lon]).addTo(trackMap).bindPopup(`Start<br>${new Date(s.timestamp).toLocaleString()}`);
        const eMk = L.marker([e.lat,e.lon]).addTo(trackMap).bindPopup(`End<br>${new Date(e.timestamp).toLocaleString()}`);
        trackMarkers.push(sMk,eMk);
      }
      trackMap.fitBounds(coords, { padding:[20,20] });
    }

    // ------------------- INIT -------------------
    document.getElementById('year').textContent = new Date().getFullYear();
    setRoute('home');
    initDemoMap();
  </script>
</body>
</html>
