<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-Ysa+g3EACr0qhvxPbKyg2Mf0Nd78Q02T+1pgiwZf2z0="
  crossorigin=""
></script>
<script>
  const map = L.map('map').setView([36.2128, -81.6741], 13); // Boone, NC

  // Add map tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
  }).addTo(map);

  let markers = [];

  async function loadPings() {
    try {
      const res = await fetch('/api/pings'); // ‚Üê fixed URL
      const pings = await res.json();

      // Remove old markers
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];

      // Add new ones
      pings.forEach(({ lat, lon, timestamp }) => {
        const marker = L.marker([lat, lon])
          .addTo(map)
          .bindPopup(`üìç<br>Lat: ${lat}<br>Lon: ${lon}<br>${new Date(timestamp).toLocaleString()}`);
        markers.push(marker);
      });
    } catch (err) {
      console.error('Failed to load pings:', err);
    }
  }

  loadPings(); // Load once
  setInterval(loadPings, 5000); // Refresh every 5s
</script>
